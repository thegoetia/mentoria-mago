<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meu Painel • Mentoria</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script src="firebase.js"></script>
  <script src="auth.js" defer></script>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <h2>Mentoria</h2>
      <div class="header-actions">
        <span id="userName" style="margin-right:12px"></span>
        <button id="themeToggle" class="btn small" onclick="Theme.toggle()">Light</button>
        <button id="logoutBtn" class="btn ghost">Sair</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="dashboard-content" class="content-area">
      <div class="welcome card">
        <h1>Bem-vindo</h1>
        <p>Abaixo estão as mentorias disponíveis para você:</p>
      </div>

      <div id="videosList" class="videos-grid"></div>
    </section>
  </main>

  <script>
    // Função auxiliar para detectar plataforma e gerar embed protegido
    function generateProtectedEmbed(url){
      const driveMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      const youtubeMatch = url.match(/(?:v=|\/)([A-Za-z0-9_-]{11})(?:$|&|\/|\?)/);
      const dropboxMatch = url.match(/dropbox.com\/.*\/([a-zA-Z0-9_-]+)\?dl=/);
      const megaMatch = url.match(/mega.nz\/file\/([a-zA-Z0-9_-]+)/);
      const mp4Match = url.match(/\.mp4$/i);

      if (driveMatch){
        const id = driveMatch[1];
        return `<video controls style="width:100%;border-radius:8px;" preload="metadata"
                  oncontextmenu="return false" ondragstart="return false" onselectstart="return false"
                  disablePictureInPicture controlsList="nodownload">
                  <source src="https://drive.google.com/uc?export=download&id=${id}" type="video/mp4">
                </video>`;
      } else if (youtubeMatch){
        const id = youtubeMatch[1];
        return `<iframe src="https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&controls=0&disablekb=1&iv_load_policy=3&fs=0"
                        frameborder="0" allowfullscreen allow="autoplay; encrypted-media"
                        oncontextmenu="return false"></iframe>`;
      } else if (dropboxMatch){
        return `<iframe src="${url.replace('?dl=0','?raw=1')}" frameborder="0" style="width:100%;height:400px;" 
                        oncontextmenu="return false"></iframe>`;
      } else if (megaMatch){
        return `<iframe src="${url}" frameborder="0" style="width:100%;height:400px;"
                        oncontextmenu="return false"></iframe>`;
      } else if (mp4Match){
        return `<video controls style="width:100%;border-radius:8px;" preload="metadata"
                  oncontextmenu="return false" ondragstart="return false" onselectstart="return false"
                  disablePictureInPicture controlsList="nodownload">
                  <source src="${url}" type="video/mp4">
                </video>`;
      } else {
        return `<p>Formato de vídeo não suportado.</p>`;
      }
    }

    // Sobrescreve a função loadStudentVideos do auth.js
    async function loadStudentVideos(){
      const listEl = document.getElementById('videosList');
      if (!listEl) return;
      listEl.innerHTML = '<p>Carregando vídeos...</p>';
      const snap = await db.collection('videos').orderBy('createdAt','asc').get();
      if (snap.empty){
        listEl.innerHTML = '<p>Nenhum vídeo disponível ainda.</p>';
        return;
      }
      listEl.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <h3>${d.title ? d.title : 'Mentoria'}</h3>
          ${generateProtectedEmbed(d.ytId)}
        `;
        listEl.appendChild(card);
      });
    }
  </script>
</body>
</html>

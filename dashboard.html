<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meu Painel • Mentoria</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <!-- Seus JS -->
  <script src="firebase.js"></script>
  <script src="auth.js" defer></script>

  <style>
    .video-card { width: 100%; margin-bottom: 30px; }
    .video-player { width: 100%; border-radius: 12px; background: #000; overflow: hidden; }
    video { width: 100%; height: auto; pointer-events: auto; }
    .video-title { margin-top: 10px; font-weight: 600; text-align: center; }
  </style>
</head>

<body oncontextmenu="return false">
<header class="site-header">
  <div class="container header-inner">
    <h2>Mentoria</h2>
    <div class="header-actions">
      <span id="userName" class="muted"></span>
      <button data-theme-toggle class="btn small" onclick="Theme.toggle()">Light</button>
      <button data-logout class="btn ghost">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <section id="dashboard-content" class="content-area" style="display:none">
    <div class="welcome card">
      <h1>Bem-vindo</h1>
      <p>Abaixo estão as mentorias disponíveis para você (ordem cronológica).</p>
    </div>

    <div id="videosList" class="videos-grid"></div>
  </section>
</main>

<script>
const supabaseClient = supabase.createClient(
  "https://xjmmgvbzfsgjltzggysv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqbW1ndmJ6ZnNnamx0emdneXN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwOTI3MDAsImV4cCI6MjA3OTY2ODcwMH0.UpJk8za096938yDfFXiLaFF7fYdZfuKA5v1Wo4xSYG4"
);

firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) return window.location.href = 'index.html';

  // Mostra nome do usuário
  const doc = await db.collection('users').doc(user.uid).get();
  const udata = doc.data();
  document.getElementById('userName').textContent = udata?.name || user.email;

  const list = document.getElementById('videosList');
  list.innerHTML = '';

  // Pega vídeos do Firestore
  const snap = await db.collection('videos').orderBy('createdAt', 'asc').get();
  if (snap.empty) {
    list.innerHTML = '<p>Nenhum vídeo disponível.</p>';
    document.getElementById('dashboard-content').style.display = 'block';
    return;
  }

  snap.forEach(async docSnap => {
    const d = docSnap.data();
    if (!d.filePath) return;

    // Gera URL pública via Supabase
    const { data, error } = await supabaseClient.storage
      .from('videos')
      .createSignedUrl(d.filePath, 60 * 60); // 1h de validade

    if (error || !data) return;

    const card = document.createElement('div');
    card.className = 'video-card';
    card.innerHTML = `
      <div class="video-player">
        <video controls disablePictureInPicture controlsList="nodownload">
          <source src="${data.signedUrl}" type="video/mp4" />
        </video>
      </div>
      <div class="video-title">${escapeHtml(d.title || 'Mentoria')}</div>
    `;
    list.appendChild(card);
  });

  document.getElementById('dashboard-content').style.display = 'block';
});

function escapeHtml(s){
  return s ? s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])) : '';
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="admin-panel" style="display:none">
    <h1>Painel Administrador</h1>

    <button id="logout">Sair</button>

    <h2>Autorizar Usuários</h2>
    <div id="user-list"></div>

    <h2>Adicionar Vídeo</h2>
    <input type="text" id="video-title" placeholder="Título do vídeo">
    <input type="text" id="video-url" placeholder="URL embed do YouTube">
    <button id="add-video-btn">Adicionar Vídeo</button>

    <h2>Vídeos Existentes</h2>
    <div id="admin-video-list"></div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
    collection, getDocs, doc, updateDoc, orderBy, query, deleteDoc, addDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "index.html";
        return;
    }

    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists() || snap.data().role !== "admin") {
        alert("Acesso negado.");
        window.location.href = "dashboard.html";
        return;
    }

    document.getElementById("admin-panel").style.display = "block";

    loadUsers();
    loadVideos();
});

async function loadUsers() {
    const usersDiv = document.getElementById("user-list");
    usersDiv.innerHTML = "";

    const q = query(collection(db, "users"));
    const usersSnap = await getDocs(q);

    usersSnap.forEach((docSnap) => {
        const data = docSnap.data();

        const div = document.createElement("div");
        div.classList.add("user-item");

        div.innerHTML = `
            <p>${data.email}</p>
            <button onclick="authorize('${docSnap.id}')">Autorizar</button>
            <button onclick="revoke('${docSnap.id}')">Revogar</button>
        `;

        usersDiv.appendChild(div);
    });
}

async function authorize(uid) {
    await updateDoc(doc(db, "users", uid), { authorized: true });
    loadUsers();
}

async function revoke(uid) {
    await updateDoc(doc(db, "users", uid), { authorized: false });
    loadUsers();
}

async function loadVideos() {
    const list = document.getElementById("admin-video-list");
    list.innerHTML = "";

    const q = query(collection(db, "videos"), orderBy("createdAt", "asc"));
    const snap = await getDocs(q);

    snap.forEach((docSnap) => {
        const data = docSnap.data();

        const div = document.createElement("div");
        div.classList.add("video-item");

        div.innerHTML = `
            <p>${data.title}</p>
            <iframe src="${data.url}" width="300"></iframe>
            <button onclick="delVideo('${docSnap.id}')">Excluir</button>
        `;

        list.appendChild(div);
    });
}

async function delVideo(id) {
    await deleteDoc(doc(db, "videos", id));
    loadVideos();
}

document.getElementById("add-video-btn").onclick = async () => {
    const title = document.getElementById("video-title").value;
    const url = document.getElementById("video-url").value;

    if (!title || !url) {
        alert("Preencha todos os campos.");
        return;
    }

    await addDoc(collection(db, "videos"), {
        title,
        url,
        createdAt: Date.now()
    });

    alert("Vídeo adicionado!");
    loadVideos();
};

document.getElementById("logout").onclick = () => signOut(auth);
</script>

</body>
</html>
